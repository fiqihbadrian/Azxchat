{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///Users/macbook/Documents/Project/WEB/azxchat/Azxchat/src/pages/api/socket.ts"],"sourcesContent":["import { NextApiRequest } from \"next\";\r\nimport NextApiResponseServerIO from \"@/types/next\"; // Pastikan tipe NextApiResponseServerIO sudah terdefinisi dengan benar\r\nimport { Server as ServerIO } from \"socket.io\";\r\nimport { Server as NetServer } from \"http\";\r\n\r\n// Konfigurasi agar bodyParser dimatikan\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n};\r\n\r\ntype User = {\r\n  id: string;\r\n  name: string;\r\n};\r\n\r\nlet users: User[] = []; // Array untuk menyimpan daftar pengguna\r\n\r\nconst socketHandler = async (req: NextApiRequest, res: NextApiResponseServerIO) => {\r\n  // Pastikan server socket hanya dibuat sekali\r\n  if (!res.socket.server.io) {\r\n    console.log(\"New Socket.io server...\");\r\n\r\n    // Mengadaptasi Next.js server ke http server\r\n    const httpServer = res.socket.server as unknown as NetServer;\r\n\r\n    // Membuat instance server socket.io\r\n    const io = new ServerIO(httpServer, {\r\n      path: \"/api/socket\", // Path yang digunakan untuk socket.io\r\n    });\r\n\r\n    // Menyimpan server socket di res.socket.server untuk akses di lain tempat\r\n    res.socket.server.io = io;\r\n\r\n    // Konfigurasi event pada koneksi socket.io\r\n    io.on(\"connection\", (socket) => {\r\n      console.log(`User connected: ${socket.id}`);\r\n\r\n      // Event userJoined (Hanya menangani sekali)\r\n      socket.on(\"userJoined\", (userName: string) => {\r\n        const newUser = { id: socket.id, name: userName };\r\n        users.push(newUser); // Menambahkan pengguna baru ke daftar\r\n        io.emit(\"users\", users); // Kirim daftar pengguna terbaru ke semua klien\r\n        io.emit(\"message\", {\r\n          user: \"System\",\r\n          msg: `${userName} has joined the chat.`, // Pesan saat pengguna baru bergabung\r\n        });\r\n      });\r\n\r\n      // Event message\r\n      socket.on(\"message\", (msgData) => {\r\n        io.emit(\"message\", msgData); // Broadcast pesan ke semua klien\r\n      });\r\n\r\n      // Event disconnect (userLeft)\r\n      socket.on(\"disconnect\", () => {\r\n        const user = users.find((u) => u.id === socket.id);\r\n        if (user) {\r\n          users = users.filter((u) => u.id !== socket.id); // Hapus pengguna dari daftar\r\n          io.emit(\"users\", users); // Kirim daftar pengguna terbaru ke semua klien\r\n          io.emit(\"message\", {\r\n            user: \"System\",\r\n            msg: `${user.name} has left the chat.`,\r\n          });\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  // Menutup response\r\n  res.end();\r\n};\r\n\r\nexport default socketHandler;\r\n"],"names":[],"mappings":";;;;;;AAEA;;;;;;AAIO,MAAM,SAAS;IACpB,KAAK;QACH,YAAY;IACd;AACF;AAOA,IAAI,QAAgB,EAAE,EAAE,wCAAwC;AAEhE,MAAM,gBAAgB,OAAO,KAAqB;IAChD,6CAA6C;IAC7C,IAAI,CAAC,IAAI,MAAM,CAAC,MAAM,CAAC,EAAE,EAAE;QACzB,QAAQ,GAAG,CAAC;QAEZ,6CAA6C;QAC7C,MAAM,aAAa,IAAI,MAAM,CAAC,MAAM;QAEpC,oCAAoC;QACpC,MAAM,KAAK,IAAI,kIAAQ,CAAC,YAAY;YAClC,MAAM;QACR;QAEA,0EAA0E;QAC1E,IAAI,MAAM,CAAC,MAAM,CAAC,EAAE,GAAG;QAEvB,2CAA2C;QAC3C,GAAG,EAAE,CAAC,cAAc,CAAC;YACnB,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,OAAO,EAAE,EAAE;YAE1C,4CAA4C;YAC5C,OAAO,EAAE,CAAC,cAAc,CAAC;gBACvB,MAAM,UAAU;oBAAE,IAAI,OAAO,EAAE;oBAAE,MAAM;gBAAS;gBAChD,MAAM,IAAI,CAAC,UAAU,sCAAsC;gBAC3D,GAAG,IAAI,CAAC,SAAS,QAAQ,+CAA+C;gBACxE,GAAG,IAAI,CAAC,WAAW;oBACjB,MAAM;oBACN,KAAK,GAAG,SAAS,qBAAqB,CAAC;gBACzC;YACF;YAEA,gBAAgB;YAChB,OAAO,EAAE,CAAC,WAAW,CAAC;gBACpB,GAAG,IAAI,CAAC,WAAW,UAAU,iCAAiC;YAChE;YAEA,8BAA8B;YAC9B,OAAO,EAAE,CAAC,cAAc;gBACtB,MAAM,OAAO,MAAM,IAAI,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,OAAO,EAAE;gBACjD,IAAI,MAAM;oBACR,QAAQ,MAAM,MAAM,CAAC,CAAC,IAAM,EAAE,EAAE,KAAK,OAAO,EAAE,GAAG,6BAA6B;oBAC9E,GAAG,IAAI,CAAC,SAAS,QAAQ,+CAA+C;oBACxE,GAAG,IAAI,CAAC,WAAW;wBACjB,MAAM;wBACN,KAAK,GAAG,KAAK,IAAI,CAAC,mBAAmB,CAAC;oBACxC;gBACF;YACF;QACF;IACF;IAEA,mBAAmB;IACnB,IAAI,GAAG;AACT;uCAEe","debugId":null}}]
}